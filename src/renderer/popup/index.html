<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Rangefinder</title>
    <link rel="stylesheet" href="../shared/base.css" />
    <link rel="stylesheet" href="./popup.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="panel">
        <div class="top">
          <div class="title">Rangefinder</div>
          <div class="hint">Enter = run Â· Esc/Ctrl+Shift+K = close</div>
        </div>

        <div class="inputs" id="inputsAuto">
          <div class="grid2">
            <select id="characterAuto">
              <option value="">Character</option>
            </select>
            <input id="toAuto" placeholder="Destination system" autocomplete="off" />
          </div>
          <div class="subhint" id="hintAuto"></div>
        </div>

        <div class="inputs" id="inputsManual">
          <div class="grid2">
            <select id="characterManual">
              <option value="">Character</option>
            </select>
            <select id="shipClassManual">
              <option value="">Ship</option>
              <option value="BLACK_OPS">Black Ops</option>
              <option value="JUMP_FREIGHTER">Jump Freighter</option>
              <option value="CAPITAL">Capital</option>
              <option value="SUPERCAP">Supercapital</option>
              <option value="RORQUAL">Rorqual</option>
              <option value="LANCER">Lancer</option>
            </select>
            <input id="fromManual" placeholder="From system" autocomplete="off" />
            <input id="toManual" placeholder="Destination system" autocomplete="off" />
          </div>
          <div class="subhint" id="hintManual"></div>
        </div>

        <div id="result" class="result">
          <div class="resultTop">
            <div id="summary" class="summary">Result</div>
            <div id="inRange" class="badge good">IN RANGE</div>
          </div>
          <div class="rline"><span>From</span><span id="fromOut">-</span></div>
          <div class="rline"><span>Ship</span><span id="shipOut">-</span></div>
          <div class="rline"><span>Distance</span><span id="distOut">-</span></div>
          <div class="rline"><span>Base range</span><span id="baseOut">-</span></div>
          <div class="rline"><span>Max range</span><span id="maxOut">-</span></div>
        </div>

        <div></div>
      </div>
    </div>

    <script>
      const inputsAuto = document.getElementById("inputsAuto");
      const inputsManual = document.getElementById("inputsManual");

      const characterAuto = document.getElementById("characterAuto");
      const toAuto = document.getElementById("toAuto");
      const hintAuto = document.getElementById("hintAuto");

      const characterManual = document.getElementById("characterManual");
      const shipClassManual = document.getElementById("shipClassManual");
      const fromManual = document.getElementById("fromManual");
      const toManual = document.getElementById("toManual");
      const hintManual = document.getElementById("hintManual");

      const resultEl = document.getElementById("result");
      const summaryEl = document.getElementById("summary");
      const inRangeEl = document.getElementById("inRange");
      const fromOutEl = document.getElementById("fromOut");
      const shipOutEl = document.getElementById("shipOut");
      const distOutEl = document.getElementById("distOut");
      const baseOutEl = document.getElementById("baseOut");
      const maxOutEl = document.getElementById("maxOut");

      let mode = "auto";
      let devState = { enabled: false };

      function hide() {
        if (window.rangefinder && typeof window.rangefinder.hidePopup === "function") {
          window.rangefinder.hidePopup();
        }
      }

      function setHint(el, text) {
        el.textContent = text || "";
      }

      function ensureSelected(selectEl) {
        if (!selectEl.value) {
          const first = Array.from(selectEl.options).find((o) => o.value);
          if (first) selectEl.value = first.value;
        }
      }

      function upsertOption(selectEl, value, label) {
        let opt = Array.from(selectEl.options).find((o) => o.value === value);
        if (!opt) {
          opt = document.createElement("option");
          opt.value = value;
          selectEl.appendChild(opt);
        }
        opt.textContent = label;
      }

      async function loadCharacters() {
        devState = { enabled: false };

        if (window.rangefinder && typeof window.rangefinder.getDevState === "function") {
          devState = await window.rangefinder.getDevState();
        }

        for (const sel of [characterAuto, characterManual]) {
          sel.innerHTML = "";
          const base = document.createElement("option");
          base.value = "";
          base.textContent = "Character";
          sel.appendChild(base);

          if (devState && devState.enabled) {
            upsertOption(sel, "dev", devState.characterName);
            sel.value = "dev";
          }

          ensureSelected(sel);
        }
      }

      function resetUI() {
        document.body.classList.remove("mode-result");
        resultEl.classList.remove("show");

        summaryEl.textContent = "Result";
        fromOutEl.textContent = "-";
        shipOutEl.textContent = "-";
        distOutEl.textContent = "-";
        baseOutEl.textContent = "-";
        maxOutEl.textContent = "-";

        inRangeEl.textContent = "IN RANGE";
        inRangeEl.classList.add("good");
        inRangeEl.classList.remove("bad");

        if (mode === "auto") {
          toAuto.value = "";
          setHint(hintAuto, "Type destination system and press Enter.");
          toAuto.focus();
        } else {
          fromManual.value = devState && devState.enabled ? devState.systemName : "";
          toManual.value = "";
          shipClassManual.value = devState && devState.enabled ? "BLACK_OPS" : "";
          setHint(hintManual, "Fill From, Ship, Destination and press Enter.");
          toManual.focus();
        }
      }

      function setMode(newMode) {
        mode = newMode === "manual" ? "manual" : "auto";
        document.body.dataset.mode = mode;
        resetUI();
      }

      async function run() {
        if (!window.rangefinder || typeof window.rangefinder.runJumpCheck !== "function") return;

        if (mode === "auto") {
          const characterKey = String(characterAuto.value || "").trim();
          const destinationSystem = String(toAuto.value || "").trim();
          if (!characterKey || !destinationSystem) return;

          setHint(hintAuto, "Checking...");
          const res = await window.rangefinder.runJumpCheck({
            mode: "auto",
            characterKey,
            destinationSystem,
          });

          if (!res || !res.ok) {
            setHint(hintAuto, res && res.error ? res.error : "Error");
            return;
          }

          document.body.classList.add("mode-result");
          resultEl.classList.add("show");

          summaryEl.textContent = res.summary;
          fromOutEl.textContent = res.fromSystem;
          shipOutEl.textContent = res.shipClass;
          distOutEl.textContent = Number(res.distLy).toFixed(2) + " LY";
          baseOutEl.textContent = Number(res.baseLy).toFixed(2) + " LY";
          maxOutEl.textContent = Number(res.maxLy).toFixed(2) + " LY";

          const ok = Boolean(res.inRange);
          inRangeEl.textContent = ok ? "IN RANGE" : "OUT OF RANGE";
          inRangeEl.classList.toggle("good", ok);
          inRangeEl.classList.toggle("bad", !ok);
          return;
        }

        const characterKey = String(characterManual.value || "").trim();
        const shipClass = String(shipClassManual.value || "").trim();
        const fromSystem = String(fromManual.value || "").trim();
        const destinationSystem = String(toManual.value || "").trim();
        if (!characterKey || !shipClass || !fromSystem || !destinationSystem) return;

        setHint(hintManual, "Checking...");
        const res = await window.rangefinder.runJumpCheck({
          mode: "manual",
          characterKey,
          shipClass,
          fromSystem,
          destinationSystem,
        });

        if (!res || !res.ok) {
          setHint(hintManual, res && res.error ? res.error : "Error");
          return;
        }

        document.body.classList.add("mode-result");
        resultEl.classList.add("show");

        summaryEl.textContent = res.summary;
        fromOutEl.textContent = res.fromSystem;
        shipOutEl.textContent = res.shipClass;
        distOutEl.textContent = Number(res.distLy).toFixed(2) + " LY";
        baseOutEl.textContent = Number(res.baseLy).toFixed(2) + " LY";
        maxOutEl.textContent = Number(res.maxLy).toFixed(2) + " LY";

        const ok = Boolean(res.inRange);
        inRangeEl.textContent = ok ? "IN RANGE" : "OUT OF RANGE";
        inRangeEl.classList.toggle("good", ok);
        inRangeEl.classList.toggle("bad", !ok);
      }

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          e.preventDefault();
          hide();
          return;
        }
        if (e.key === "Enter") {
          e.preventDefault();
          run();
          return;
        }
      });

      if (window.rangefinder && typeof window.rangefinder.onPopupReset === "function") {
        window.rangefinder.onPopupReset(() => resetUI());
      }

      if (window.rangefinder && typeof window.rangefinder.onPopupMode === "function") {
        window.rangefinder.onPopupMode((m) => setMode(m));
      }

      loadCharacters().then(() => setMode("auto"));
    </script>
  </body>
</html>
