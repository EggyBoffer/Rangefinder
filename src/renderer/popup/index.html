<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Rangefinder</title>
    <link rel="stylesheet" href="../shared/base.css" />
    <link rel="stylesheet" href="./popup.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="panel">
        <div class="top">
          <div class="title">Rangefinder</div>
          <div class="hint">Run with Enter! Close with Esc.</div>
        </div>

        <div class="inputs" id="inputsAuto">
          <div class="grid2">
            <select id="characterAuto">
              <option value="">Character</option>
            </select>
            <input id="toAuto" placeholder="Destination system" autocomplete="off" />
          </div>
          <div class="subhint" id="hintAuto"></div>
        </div>

        <div class="inputs" id="inputsManual">
          <div class="grid2">
            <select id="characterManual">
              <option value="">Character</option>
            </select>
            <select id="shipClassManual">
              <option value="">Ship</option>
              <option value="BLACK_OPS">Black Ops</option>
              <option value="JUMP_FREIGHTER">Jump Freighter</option>
              <option value="CAPITAL">Capital</option>
              <option value="SUPERCAP">Supercapital</option>
              <option value="RORQUAL">Rorqual</option>
              <option value="LANCER">Lancer</option>
            </select>
            <input id="fromManual" placeholder="From system" autocomplete="off" />
            <input id="toManual" placeholder="Destination system" autocomplete="off" />
          </div>
          <div class="subhint" id="hintManual"></div>
        </div>

        <div id="result" class="result">
          <div class="resultTop">
            <div id="summary" class="summary">Result</div>
            <div id="inRange" class="badge good">IN RANGE</div>
          </div>
          <div class="rline"><span>From</span><span id="fromOut">-</span></div>
          <div class="rline"><span>Ship</span><span id="shipOut">-</span></div>
          <div class="rline"><span>Distance</span><span id="distOut">-</span></div>
          <div class="rline"><span>Base range</span><span id="baseOut">-</span></div>
          <div class="rline"><span>Max range</span><span id="maxOut">-</span></div>
          <div class="rline"><span>Midpoints</span><span id="midOut">-</span></div>
          <div class="rline"><span>Route</span><span id="routeOut">-</span></div>
        </div>

        <div></div>
      </div>
    </div>

    <script>
      const inputsAuto = document.getElementById("inputsAuto");
      const inputsManual = document.getElementById("inputsManual");

      const characterAuto = document.getElementById("characterAuto");
      const toAuto = document.getElementById("toAuto");
      const hintAuto = document.getElementById("hintAuto");

      const characterManual = document.getElementById("characterManual");
      const shipClassManual = document.getElementById("shipClassManual");
      const fromManual = document.getElementById("fromManual");
      const toManual = document.getElementById("toManual");
      const hintManual = document.getElementById("hintManual");

      const resultEl = document.getElementById("result");
      const summaryEl = document.getElementById("summary");
      const inRangeEl = document.getElementById("inRange");
      const fromOutEl = document.getElementById("fromOut");
      const shipOutEl = document.getElementById("shipOut");
      const distOutEl = document.getElementById("distOut");
      const baseOutEl = document.getElementById("baseOut");
      const maxOutEl = document.getElementById("maxOut");
      const midOutEl = document.getElementById("midOut");
      const routeOutEl = document.getElementById("routeOut");

      const suggestBox = document.createElement("div");
      suggestBox.className = "suggestBox";
      document.body.appendChild(suggestBox);

      let suggestActiveInput = null;
      let suggestItems = [];
      let suggestIndex = -1;
      let suggestReqId = 0;
      let suggestTimer = null;

      function fmtSec(v) {
        const n = Number(v);
        if (!Number.isFinite(n)) return "";
        return n.toFixed(1);
      }

      function hideSuggest() {
        suggestBox.style.display = "none";
        suggestBox.innerHTML = "";
        suggestActiveInput = null;
        suggestItems = [];
        suggestIndex = -1;
      }

      function positionSuggestForInput(inputEl) {
        const r = inputEl.getBoundingClientRect();
        const top = Math.round(r.bottom + 6);
        const left = Math.round(r.left);
        const width = Math.round(r.width);
        suggestBox.style.position = "fixed";
        suggestBox.style.top = `${top}px`;
        suggestBox.style.left = `${left}px`;
        suggestBox.style.width = `${width}px`;
      }

      function renderSuggest() {
        suggestBox.innerHTML = "";
        for (let i = 0; i < suggestItems.length; i++) {
          const it = suggestItems[i];
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "suggestItem" + (i === suggestIndex ? " active" : "");
          const sec = fmtSec(it.secStatus !== null && typeof it.secStatus !== "undefined" ? it.secStatus : it.security);
          btn.textContent = sec ? `${it.name} (${sec})` : it.name;
          btn.addEventListener("mousedown", (e) => {
            e.preventDefault();
            if (!suggestActiveInput) return;
            suggestActiveInput.value = it.name;
            hideSuggest();
            suggestActiveInput.focus();
          });
          suggestBox.appendChild(btn);
        }
        if (suggestItems.length) {
          suggestBox.style.display = "block";
        } else {
          hideSuggest();
        }
      }

      async function fetchSuggest(inputEl, raw) {
        const q = String(raw || "").trim();
        if (!q) {
          hideSuggest();
          return;
        }
        if (!window.rangefinder || typeof window.rangefinder.suggestSystems !== "function") return;

        const myId = ++suggestReqId;
        const rows = await window.rangefinder.suggestSystems(q, 10);
        if (myId !== suggestReqId) return;
        if (!document.activeElement || document.activeElement !== inputEl) return;

        suggestActiveInput = inputEl;
        suggestItems = Array.isArray(rows) ? rows.slice(0, 10) : [];
        suggestIndex = suggestItems.length ? 0 : -1;
        positionSuggestForInput(inputEl);
        renderSuggest();
      }

      function scheduleSuggest(inputEl) {
        if (suggestTimer) window.clearTimeout(suggestTimer);
        suggestTimer = window.setTimeout(() => fetchSuggest(inputEl, inputEl.value), 90);
      }

      function attachSuggest(inputEl) {
        inputEl.addEventListener("input", () => scheduleSuggest(inputEl));
        inputEl.addEventListener("focus", () => scheduleSuggest(inputEl));
        inputEl.addEventListener("blur", () => {
          window.setTimeout(() => {
            if (!suggestBox.contains(document.activeElement)) hideSuggest();
          }, 120);
        });
      }

      let mode = "auto";
      let devState = { enabled: false };

      let checkingTimer = null;
      let checkingStart = 0;

      function stopChecking() {
        if (checkingTimer) {
          window.clearInterval(checkingTimer);
          checkingTimer = null;
        }
      }

      function startChecking(hintEl, label) {
        stopChecking();
        checkingStart = Date.now();
        let dots = 0;
        checkingTimer = window.setInterval(() => {
          const elapsed = Math.floor((Date.now() - checkingStart) / 1000);
          dots = (dots + 1) % 4;
          const d = dots === 0 ? "" : ".".repeat(dots);
          const t = elapsed > 0 ? ` (${elapsed}s)` : "";
          setHint(hintEl, `${label}${d}${t}`);
        }, 250);
      }

      function hide() {
        stopChecking();
        if (window.rangefinder && typeof window.rangefinder.hidePopup === "function") {
          window.rangefinder.hidePopup();
        }
      }

      function setHint(el, text) {
        el.textContent = text || "";
      }

      function ensureSelected(selectEl) {
        if (!selectEl.value) {
          const first = Array.from(selectEl.options).find((o) => o.value);
          if (first) selectEl.value = first.value;
        }
      }

      function upsertOption(selectEl, value, label) {
        let opt = Array.from(selectEl.options).find((o) => o.value === value);
        if (!opt) {
          opt = document.createElement("option");
          opt.value = value;
          selectEl.appendChild(opt);
        }
        opt.textContent = label;
      }

      function parseCharacterSelection(rawValue) {
        const v = String(rawValue || "").trim();
        if (!v) return null;

        if (v === "dev") return { characterKey: "dev" };
        if (v.startsWith("esi:")) {
          const id = Number(v.slice(4));
          if (Number.isFinite(id) && id > 0) return { characterKey: "esi", characterId: id };
        }

        return null;
      }

      async function loadCharacters() {
        devState = { enabled: false };

        if (window.rangefinder && typeof window.rangefinder.getDevState === "function") {
          devState = await window.rangefinder.getDevState();
        }

        let activeId = null;
        let esiChars = [];

        if (window.rangefinder && typeof window.rangefinder.esiListCharacters === "function") {
          const store = await window.rangefinder.esiListCharacters();
          if (store && typeof store.activeCharacterId === "number") activeId = store.activeCharacterId;
          if (store && Array.isArray(store.characters)) esiChars = store.characters;
        }

        for (const sel of [characterAuto, characterManual]) {
          sel.innerHTML = "";
          const base = document.createElement("option");
          base.value = "";
          base.textContent = "Character";
          sel.appendChild(base);

          if (devState && devState.enabled) {
            upsertOption(sel, "dev", devState.characterName);
          }

          for (const ch of esiChars) {
            const id = Number(ch.characterId || 0);
            if (!id) continue;
            const name = String(ch.characterName || "").trim() || `Character ${id}`;
            upsertOption(sel, `esi:${id}`, name);
          }

          if (activeId) {
            const activeKey = `esi:${activeId}`;
            const hasActive = Array.from(sel.options).some((o) => o.value === activeKey);
            if (hasActive) sel.value = activeKey;
            else if (devState && devState.enabled) sel.value = "dev";
          } else if (devState && devState.enabled) {
            sel.value = "dev";
          }

          ensureSelected(sel);
        }
      }

      function resetUI() {
        stopChecking();
        hideSuggest();
        if (window.rangefinder && typeof window.rangefinder.setResultMode === "function") {
          window.rangefinder.setResultMode(false);
        }

        document.body.classList.remove("mode-result");
        resultEl.classList.remove("show");

        summaryEl.textContent = "Result";
        fromOutEl.textContent = "-";
        shipOutEl.textContent = "-";
        distOutEl.textContent = "-";
        baseOutEl.textContent = "-";
        maxOutEl.textContent = "-";
        midOutEl.textContent = "-";
        routeOutEl.textContent = "-";

        inRangeEl.textContent = "IN RANGE";
        inRangeEl.classList.add("good");
        inRangeEl.classList.remove("bad");

        if (mode === "auto") {
          toAuto.value = "";
          setHint(hintAuto, "Type destination system and press Enter.");
          toAuto.focus();
        } else {
          fromManual.value = devState && devState.enabled ? devState.systemName : "";
          toManual.value = "";
          shipClassManual.value = devState && devState.enabled ? "BLACK_OPS" : "";
          setHint(hintManual, "Fill From, Ship, Destination and press Enter.");
          toManual.focus();
        }
      }

      function setMode(newMode) {
        mode = newMode === "manual" ? "manual" : "auto";
        document.body.dataset.mode = mode;
        resetUI();
      }

      function renderResult(res) {
        if (window.rangefinder && typeof window.rangefinder.setResultMode === "function") {
          window.rangefinder.setResultMode(true);
        }

        document.body.classList.add("mode-result");
        resultEl.classList.add("show");

        summaryEl.textContent = res.summary;
        fromOutEl.textContent = res.fromSystem;
        shipOutEl.textContent = res.shipClass;
        distOutEl.textContent = Number(res.distLy).toFixed(2) + " LY";
        baseOutEl.textContent = Number(res.baseLy).toFixed(2) + " LY";
        maxOutEl.textContent = Number(res.maxLy).toFixed(2) + " LY";

        if (res.midpointsNeeded === null || typeof res.midpointsNeeded === "undefined") {
          midOutEl.textContent = "-";
        } else {
          midOutEl.textContent = String(res.midpointsNeeded);
        }

        if (Array.isArray(res.route) && res.route.length) {
          routeOutEl.textContent = res.route.join(" â†’ ");
        } else {
          routeOutEl.textContent = "-";
        }

        const ok = Boolean(res.inRange);
        inRangeEl.textContent = ok ? "IN RANGE" : "OUT OF RANGE";
        inRangeEl.classList.toggle("good", ok);
        inRangeEl.classList.toggle("bad", !ok);
      }

      async function run() {
        stopChecking();
        if (!window.rangefinder || typeof window.rangefinder.runJumpCheck !== "function") return;

        if (mode === "auto") {
          const sel = parseCharacterSelection(characterAuto.value);
          const destinationSystem = String(toAuto.value || "").trim();
          if (!sel || !destinationSystem) return;

          startChecking(hintAuto, "Checking");
          const res = await window.rangefinder.runJumpCheck({
            mode: "auto",
            characterKey: sel.characterKey,
            characterId: sel.characterId,
            destinationSystem,
          });

          stopChecking();

          if (!res || !res.ok) {
            setHint(hintAuto, res && res.error ? res.error : "Error");
            return;
          }

          renderResult(res);
          setHint(hintAuto, "");
          return;
        }

        const sel = parseCharacterSelection(characterManual.value);
        const shipClass = String(shipClassManual.value || "").trim();
        const fromSystem = String(fromManual.value || "").trim();
        const destinationSystem = String(toManual.value || "").trim();
        if (!sel || !shipClass || !fromSystem || !destinationSystem) return;

        startChecking(hintManual, "Checking");
        const res = await window.rangefinder.runJumpCheck({
          mode: "manual",
          characterKey: sel.characterKey,
          characterId: sel.characterId,
          shipClass,
          fromSystem,
          destinationSystem,
        });

        stopChecking();

        if (!res || !res.ok) {
          setHint(hintManual, res && res.error ? res.error : "Error");
          return;
        }

        renderResult(res);
        setHint(hintManual, "");
      }

      window.addEventListener("keydown", (e) => {
        if (suggestBox.style.display === "block" && suggestActiveInput) {
          if (e.key === "Escape") {
            e.preventDefault();
            hideSuggest();
            return;
          }
          if (e.key === "ArrowDown") {
            e.preventDefault();
            if (suggestItems.length) {
              suggestIndex = Math.min(suggestItems.length - 1, suggestIndex + 1);
              renderSuggest();
            }
            return;
          }
          if (e.key === "ArrowUp") {
            e.preventDefault();
            if (suggestItems.length) {
              suggestIndex = Math.max(0, suggestIndex - 1);
              renderSuggest();
            }
            return;
          }
          if (e.key === "Enter") {
            if (suggestIndex >= 0 && suggestItems[suggestIndex]) {
              e.preventDefault();
              suggestActiveInput.value = suggestItems[suggestIndex].name;
              hideSuggest();
              suggestActiveInput.focus();
              return;
            }
          }
        }
        if (e.key === "Escape") {
          e.preventDefault();
          hide();
          return;
        }
        if (e.key === "Enter") {
          e.preventDefault();
          run();
          return;
        }
      });

      document.addEventListener("mousedown", (e) => {
        if (suggestBox.style.display !== "block") return;
        if (suggestBox.contains(e.target)) return;
        if (suggestActiveInput && suggestActiveInput.contains(e.target)) return;
        hideSuggest();
      });

      if (window.rangefinder && typeof window.rangefinder.onPopupReset === "function") {
        window.rangefinder.onPopupReset(() => resetUI());
      }

      if (window.rangefinder && typeof window.rangefinder.onPopupMode === "function") {
        window.rangefinder.onPopupMode((m) => setMode(m));
      }

      attachSuggest(toAuto);
      attachSuggest(fromManual);
      attachSuggest(toManual);

      loadCharacters().then(() => setMode("auto"));
    </script>
  </body>
</html>
